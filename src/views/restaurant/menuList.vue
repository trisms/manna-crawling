
<template>
	<!-- BEGIN breadcrumb -->
<!--	<ol class="breadcrumb float-xl-end">
		<li class="breadcrumb-item"><a href="javascript:;">Home</a></li>
		<li class="breadcrumb-item"><a href="javascript:;">Library</a></li>
		<li class="breadcrumb-item active">Data</li>
	</ol>
	&lt;!&ndash; END breadcrumb &ndash;&gt;
	&lt;!&ndash; BEGIN page-header &ndash;&gt;
	<h1 class="page-header">ìŒì‹ì <small></small></h1>
	&lt;!&ndash; END page-header &ndash;&gt;-->

	<!-- BEGIN panel -->
<!--  <div class="list-group list-group-flush fw-bold">
    <div class="list-group-item d-flex align-items-center">
      <div class="flex-fill">
        <div>Name</div>
        <div class="text-body text-opacity-60">Sean Ngu</div>
      </div>
      <div class="w-100px">
        <a href="#modalEdit" data-bs-toggle="modal" class="btn btn-secondary w-100px">Edit</a>
      </div>
    </div>
    <div class="list-group-item d-flex align-items-center">
      <div class="flex-fill">
        <div>Username</div>
        <div class="text-body text-opacity-60">@seantheme</div>
      </div>
      <div>
        <a href="#modalEdit" data-bs-toggle="modal" class="btn btn-secondary w-100px">Edit</a>
      </div>
    </div>
  </div>-->

	<panel>
<!--		<panel-header>
			<panel-title>


      </panel-title>
			<panel-toolbar />
		</panel-header>-->

		<panel-body>

      <div class="card border-0">
        <div class="note  mb-0 border">
          <div class="note-content ">
            <h4> <i class="fa fa-info-circle fa-fw"></i> <b>ê°€ë§¹ì  ì •ë³´</b> - ( {{ store.form.stName }} ) </h4>
            <table class="table table-condensed p-0 bg-none mb-0">
              <tbody>
              <!-- ğŸ“Œ ê¸°ë³¸ì •ë³´ -->
              <tr>
                <td nowrap="" class="w-50">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-200 w-15px h-15px rounded me-2"></div>
                    <div><b>ê°€ë§¹ì ë²ˆí˜¸</b> : {{ store.form.grStNo }}</div>
                  </div>
                </td>
                <td nowrap="" class="w-50">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-100 w-15px h-15px rounded me-2"></div>
                    <div><b>ê°€ì…ê²½ë¡œ</b> : {{ getAppName(store.form.appType) }}</div>
                  </div>
                </td>
              </tr>
              <tr>
                <td nowrap="">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-200 w-15px h-15px rounded me-2"></div>
                    <div><b>ê°€ë§¹ì ì½”ë“œ</b> : {{ store.form.stCode }}</div>
                  </div>
                </td>
                <td nowrap="">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-100 w-15px h-15px rounded me-2"></div>
                    <div><b>ìƒì„±ì¼</b> : {{ store.form.putDate }}</div>
                  </div>
                </td>
              </tr>

              <!-- ğŸ“Œ ì‚¬ì—…ì ì •ë³´ -->
              <tr>
                <td nowrap="">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-200 w-15px h-15px rounded me-2"></div>
                    <div><b>ëŒ€í‘œì</b> : {{ store.form.stOwner }}</div>
                  </div>
                </td>
                <td nowrap="">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-100 w-15px h-15px rounded me-2"></div>
                    <div><b>ì „í™”ë²ˆí˜¸</b> : {{ store.form.stTel }}</div>
                  </div>
                </td>
              </tr>

              <!-- ğŸ“Œ ì—°ë½ì²˜ / ì£¼ì†Œ -->
              <tr>
                <td nowrap="">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-300 w-15px h-15px rounded me-2"></div>
                    <div><b>ê°€ë§¹ì ì£¼ì†Œ</b> : {{ store.form.stAddr }}</div>
                  </div>
                </td>
                <td nowrap="" >
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-300 w-15px h-15px rounded me-2"></div>
                    <div><b>ì˜ì—…ì‹œê°„</b> : {{ store.form.originWorkTime }}</div>
                  </div>
                </td>
              </tr>
              <tr>
                <td nowrap="" colspan="2">
                  <div class="d-flex align-items-center">
                    <div class="bg-indigo-300 w-15px h-15px rounded me-2"></div>
                    <div><b>ë§¤ì¥ì†Œê°œ</b> : {{ store.form.stAppMemo }}</div>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="d-flex between nav nav-tabs nav-tabs-v2 pt-3 justify-content-between">
          <div class="nav nav-tabs nav-tabs-v2 border-bottom-0 " role="tablist">
            <div class="nav-item me-2" role="presentation "><div class="nav-link btn btn-sm btn-white   px-2"  aria-selected="true" role="tab" disabled="">ìƒí’ˆê·¸ë£¹ :</div></div>
            <div class="nav-item me-2" role="presentation " v-for="(item, index) in store.grpList" :key="item.grStGrpNo">
              <div class="nav-link btn btn-sm btn-white   px-2"  :class="{ active: index == 0 }"  data-bs-toggle="tab" aria-selected="false" role="tab" @click="selectGrpList(item.grStGrpNo)">{{ item.grpName }}</div>
            </div>
          </div>
          <div class="nav nav-tabs nav-tabs-v2 border-bottom-0" role="tablist">
            <button type="button" class="btn btn-sm btn-gray" @click="deleteImage" ><i class="far fa-lg fa-fw me-10px fa-circle-xmark ms-n1"></i> ì„ íƒ ì´ë¯¸ì§€ ì‚­ì œ</button>
          </div>
        </div>
        <div class="tab-content pt-4">
          <div class="tab-pane fade show active" id="allTab" role="tabpanel">
            <!-- BEGIN table -->
            <div class="table-responsive">
              <table class="table table-hover text-nowrap">
                <thead>
                <tr>
                  <th class="pt-0 pb-2">
                    <div class="form-check">
                      <input
                          type="checkbox"
                          class="form-check-input"
                          id="allCheck"
                          v-model="allChecked"
                          @change="toggleAll"
                      />
                      <label class="form-check-label" for="allCheck"></label>
                    </div>
                  </th>
                  <th class="pt-0 pb-2">ì´ë¯¸ì§€</th>
                  <th class="pt-0 pb-2">ìƒí’ˆê·¸ë£¹</th>
                  <th class="pt-0 pb-2">ë°°ë‹¬ê°€ê²©</th>
                  <th class="pt-0 pb-2">í¬ì¥ê°€ê²©</th>
                  <th class="pt-0 pb-2">ì„±ì¸ì¸ì¦</th>
                  <th class="pt-0 pb-2">ìƒí’ˆì„¤ëª…</th>
                  <th class="pt-0 pb-2">ì¶”ê°€ìƒí’ˆ</th>
                  <th class="pt-0 pb-2">ì‹œìŠ¤í…œì´ë¯¸ì§€</th>
                  <th class="pt-0 pb-2">ì´ë¯¸ì§€ ì—…ë¡œë“œ</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="item in store.grpItems" :key="item.grStGoodsNo">
                  <td class="w-10px align-middle"  @click.stop="toggleItem(item.grStGoodsNo)">
                    <div class="form-check">
                      <input
                          type="checkbox"
                          class="form-check-input"
                          :id="'product' + item.grStGoodsNo"
                          :value="item.grStGoodsNo"
                          :checked="checkedItems.includes(item.grStGoodsNo)"
                      />
                      {{ item.grStGoodsNo }}
                      <label class="form-check-label" :for="'product' + item.grStGoodsNo"></label>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div
                          class="w-50px h-50px bg-light d-flex align-items-center justify-content-center"
                          @click="openImageModal(item.image ? item.image.mainPath : '')"
                          style="cursor: pointer;"
                      >
                        <img alt="" class="mw-100 mh-100" style=""  :src="item.image ? item.image.mainThumbPath : ''">

                      </div>
                      <div class="ms-3">
                        <a href="extra_product_details.html" class="text-dark text-decoration-none">{{ item.goodsName }}</a>
                      </div>
                    </div>
                  </td>
                  <td class="align-middle">{{ item.grpName}}</td>
                  <td class="align-middle">{{ formatPrice(item.sellPrice)}} ì›</td>
                  <td class="align-middle">{{ formatPrice(item.ordPrice)}} ì›</td>
                  <td class="align-middle">{{ adultYn(item.adultYn)}}</td>
                  <td class="align-middle text-ellipsis">{{ item.goodsMemo}}</td>
                  <td class="align-middle">{{ item.goodsMappCnt}} ê°œ</td>
                  <td class="align-middle"><button type="button" class="btn btn-sm btn-white"><i class="fa fa-fw fa-check ms-n1"></i> ì´ë¯¸ì§€ ì„ íƒ</button>
                  </td>
                  <td class="align-middle">
                    <input
                        type="file"
                        ref="fileInputs"
                        class="d-none"
                        accept="image/*"
                        @change="handleFileChange($event, item)"
                    />
                    <button
                        type="button"
                        class="btn btn-sm btn-white"
                        @click="triggerFileInput($event)"
                    >
                      <i class="fa fa-fw fa-upload ms-n1"></i> ì—…ë¡œë“œ
                    </button>
                  </td>

                </tr>
                </tbody>
              </table>
            </div>
            <!-- END table -->
            <Pagenation
                v-model="currentPage"
                :total="store.grpItems?.length ?? 0"
                :perPage="itemsPerPage"
            />
          </div>
        </div>
      </div>
		</panel-body>
	</panel>
  <div v-if="showImageModal" class="image-modal-backdrop" @click="closeImageModal">
    <div class="image-modal-content" @click.stop>
      <img :src="modalImageSrc" alt="ì´ë¯¸ì§€ í™•ëŒ€" />
      <button class="btn-close" @click="closeImageModal">Ã—</button>
    </div>
  </div>
	<!-- END panel -->
</template>
<script setup lang="ts">
import {ref, computed, watch, onBeforeMount} from 'vue'
import {useRestaurantStore} from "@/stores/restaurant/useRestaurantStore";
import Pagenation from "@/components/common/Pagenation.vue";
import FormMultipleImage from "@/components/form/FormMultipleImage.vue";
const store = useRestaurantStore();
const selectGrStGrpNo = ref(1);
onBeforeMount(()=>  {
  if( store.grpList){
    selectGrStGrpNo.value = store.grpList[0].grStGrpNo;
  }
})

// ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìƒíƒœ
const checkedItems = ref<string[]>([]); // grStNoë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²´í¬ ìƒíƒœ ê´€ë¦¬

const showImageModal = ref(false)      // ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€
const modalImageSrc = ref('')          // í™•ëŒ€í•  ì´ë¯¸ì§€ ê²½ë¡œ

function openImageModal(src: string) {
  modalImageSrc.value = src
  showImageModal.value = true
}

function closeImageModal() {
  showImageModal.value = false
  modalImageSrc.value = ''
}
const allChecked = ref(false);
// allCheck í´ë¦­ ì‹œ í† ê¸€
function toggleAll() {
  if (allChecked.value) {
    // ì „ì²´ ì²´í¬
    checkedItems.value = store.grpItems.map(item => item.grStGoodsNo);
  } else {
    // ì „ì²´ í•´ì œ
    checkedItems.value = [];
  }
}

function toggleItem(grStGoodsNo: string) {
  const index = checkedItems.value.indexOf(grStGoodsNo);
  if (index > -1) {
    checkedItems.value.splice(index, 1);
  } else {
    checkedItems.value.push(grStGoodsNo);
  }

  // allChecked ìƒíƒœ ìë™ ë°˜ì˜
  allChecked.value = checkedItems.value.length === store.grpList.length;
}


// âœ… í˜ì´ì§€ ê³„ì‚°
const paginatedData = computed(() => {
  const arr = store.grpList || []        // store.itemsê°€ proxyë©´ ìì²´ê°€ ë°°ì—´ì„
  const start = (currentPage.value - 1) * itemsPerPage
  return arr.slice(start, start + itemsPerPage)
})


const currentPage = ref(1)
const itemsPerPage = 10
const getAppName = (appType: string | number) => {
  if (appType === '1' || appType === 1) return 'ë°°ë¯¼';
  if (appType === '2' || appType === 2) return 'ì¿ íŒ¡';
  return '';
};


const adultYn = (appType: string | number) => {
  if (appType === 'Y' ) return 'ì¸ì¦';
  if (appType === 'N' ) return 'ë¯¸ì¸ì¦';
  return '';
};
function formatPrice(value: number | string) {
  if (value === null || value === undefined) return '';
  return Number(value).toLocaleString('ko-KR');
}


const selectGrpList = (grStGrpNo : number | string) => {
  selectGrStGrpNo.value = grStGrpNo;
  store.callGrpListAPI(store.form.grStNo, grStGrpNo, ()=> {

  })
}
const deleteImage = async () => {
  if( checkedItems.value.length > 0){
    await store.deleteImageAPI({grStGoodsNoList : checkedItems.value},() => {
      allChecked.value = false;
      checkedItems.value= [];
      if(store.grpList) {
        store.callGrpListAPI(store.form.grStNo,  selectGrStGrpNo.value, ()=> {
          checkedItems.value.map((item) => {
            toggleItem(item)
          });
          checkedItems.value= [];
        })
      }
    })
  } else {
    alert('ì‚­ì œí•  ì´ë¯¸ì§€ë¥¼ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }

}
const fileInputs = ref<HTMLInputElement[]>([])

// ë²„íŠ¼ í´ë¦­ â†’ í•´ë‹¹ rowì˜ input í´ë¦­
function triggerFileInput(event: Event) {
  const button = event.currentTarget as HTMLElement
  const td = button.closest("td")
  const input = td?.querySelector("input[type='file']") as HTMLInputElement
  input?.click()
}

// íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
async function handleFileChange(e: Event, item: any) {
  const target = e.target as HTMLInputElement
  if (!target.files || target.files.length === 0) return

  const file = target.files[0]

  const formData = new FormData()
  formData.append("image", file)

  const query = { dest : 'goods', grStGoodsNo : item.grStGoodsNo }
  // ğŸš€ API í˜¸ì¶œ (ì˜ˆì‹œ)
  await store.calluploadImgAPI(formData,query, (res) => {
    allChecked.value = false;
    checkedItems.value= [];
    // ì—…ë¡œë“œ í›„ ì´ë¯¸ì§€ ê²½ë¡œ ì—…ë°ì´íŠ¸
    if(store.grpList) {
      store.callGrpListAPI(store.form.grStNo,  selectGrStGrpNo.value, ()=> {

      })
    }
  })

  // input íŒŒì¼ ì´ˆê¸°í™”
  target.value = ""
}


</script>
<style scoped>
.borde-radius-0 {
  border-radius: 0px;
}
.card-body {
  flex: 1 1 auto;
  padding: var(--bs-card-spacer-y) var(--bs-card-spacer-x);
  color: var(--bs-card-color);
  background: #f4f4f4;
}
.info-section {
  border: 1px solid #e6e6e6;
  border-radius: 6px;
  padding: 12px 14px;
  margin-bottom: 12px;
  background: #fafafa;
}

.info-title {
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 14px;
  color: #333;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  row-gap: 6px;
  column-gap: 20px;
}

.info-row {
  display: flex;
  align-items: center;
}

.info-label {
  color: #777;
  width: 100px;       /* ë¼ë²¨ ì •ë ¬ì´ í•µì‹¬ */
  font-size: 13px;
}

.info-value {
  font-weight: 500;
  color: #222;
  font-size: 13px;
}

.image-modal-backdrop {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1050;
}

.image-modal-content {
  position: relative;
  background: #fff;
  padding: 10px;
  border-radius: 8px;
  max-width: 90%;
  max-height: 90%;
}

.image-modal-content img {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

.image-modal-content .btn-close {
  position: absolute;
  top: 5px; right: 5px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

.text-ellipsis {
  max-width: 150px;      /* ì›í•˜ëŠ” ë„ˆë¹„ */
  white-space: nowrap;   /* í•œ ì¤„ë¡œ */
  overflow: hidden;      /* ë„˜ì¹˜ë©´ ìˆ¨ê¹€ */
  text-overflow: ellipsis; /* ... ì²˜ë¦¬ */
}
</style>
